// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

// Note that some adapters may set a maximum length for the String type by default, please ensure your strings are long
// enough when changing adapters.
// See https://www.prisma.io/docs/orm/reference/prisma-schema-reference#string for more information
datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Session {
  id            String    @id
  shop          String
  state         String
  isOnline      Boolean   @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String
  userId        BigInt?
  firstName     String?
  lastName      String?
  email         String?
  accountOwner  Boolean   @default(false)
  locale        String?
  collaborator  Boolean?  @default(false)
  emailVerified Boolean?  @default(false)
}

model OrderStatus {
  id          String   @id @default(uuid())
  // 支持按 line item 记录状态：lineItemId 可为空
  orderId     String
  lineItemId  String?  
  status      String   // 自定义状态，例如: 待生产、生产中、暂停生产、待发货、已发货
  note        String?  // 备注信息
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())
}

model Tag {
  id          String      @id @default(uuid())
  name        String      @unique // 标签名称，唯一
  color       String      @default("#808080") // 标签颜色，用于显示
  description String?     // 标签描述
  orderTags   OrderTag[]  // 关联的订单
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model OrderTag {
  id        String   @id @default(uuid())
  orderId   String   // Shopify订单ID
  tagId     String   // 标签ID
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  
  @@unique([orderId, tagId]) // 同一订单不能重复添加相同标签
}

// 布料材质模型
model Fabric {
  id          String        @id @default(uuid())
  code        String        @unique // 布料编号，如 "8823"
  name        String?       // 布料名称（可选）
  description String?       // 布料描述
  colors      FabricColor[] // 关联的颜色
  prices      FabricPrice[] // 价格历史记录
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

// 布料颜色模型
model FabricColor {
  id          String              @id @default(uuid())
  fabricId    String              // 关联的布料ID
  fabric      Fabric              @relation(fields: [fabricId], references: [id], onDelete: Cascade)
  colorCode   String              // 颜色编号，如 "1", "2"
  colorName   String?             // 颜色名称（可选）
  fullCode    String              @unique // 完整编号，如 "8823-1"
  prices      FabricColorPrice[]  // 该颜色的独立价格记录
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  
  @@unique([fabricId, colorCode]) // 同一布料下颜色编号唯一
}

// 布料基础价格历史记录（应用于整个布料材质）
model FabricPrice {
  id              String   @id @default(uuid())
  fabricId        String   // 关联的布料ID
  fabric          Fabric   @relation(fields: [fabricId], references: [id], onDelete: Cascade)
  fabricPrice     Float    // 布料价格（每米/码）
  effectiveDate   DateTime @default(now()) // 生效时间
  createdAt       DateTime @default(now())
  createdBy       String?  // 创建人
}

// 布料颜色独立价格历史记录（覆盖基础价格）
model FabricColorPrice {
  id              String      @id @default(uuid())
  colorId         String      // 关联的颜色ID
  color           FabricColor @relation(fields: [colorId], references: [id], onDelete: Cascade)
  fabricPrice     Float       // 布料价格（每米/码）
  effectiveDate   DateTime    @default(now()) // 生效时间
  createdAt       DateTime    @default(now())
  createdBy       String?     // 创建人
}

// 衬布类型及价格管理
model Lining {
  id              String        @id @default(uuid())
  type            String        @unique // 衬布类型名称，如 "No Lining", "Standard", "Blackout"
  price           Float         // 衬布价格（每米/码）
  description     String?       // 描述
  prices          LiningPrice[] // 价格历史记录
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
}

// 衬布价格历史记录
model LiningPrice {
  id              String   @id @default(uuid())
  liningId        String   // 关联的衬布ID
  lining          Lining   @relation(fields: [liningId], references: [id], onDelete: Cascade)
  price           Float    // 衬布价格（每米/码）
  effectiveDate   DateTime @default(now()) // 生效时间
  createdAt       DateTime @default(now())
  createdBy       String?  // 创建人
}
