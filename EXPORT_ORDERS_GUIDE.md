# 订单批量导出功能说明

## 功能概述
订单管理页面提供了两种导出方式：
1. **导出选中订单**：手动勾选订单后导出
2. **批量导出订单**：根据时间和状态条件自动导出所有符合条件的订单（无需勾选）

## 新增功能：批量导出订单

### 功能入口
在订单列表页面右上角，有两个导出按钮：
- **导出选中订单**：需要先勾选订单才能使用
- **批量导出订单**：点击后弹出对话框，设置条件后导出

### 使用步骤

1. **点击"批量导出订单"按钮**
   - 无需勾选任何订单
   - 会弹出批量导出对话框

2. **设置筛选条件**（可选）:
   - **开始日期**: 选择订单创建的开始时间（留空表示不限制）
   - **结束日期**: 选择订单创建的结束时间（留空表示不限制）
   - **订单状态**: 
     - 全部订单状态（默认）
     - 待处理
     - 生产中
     - 已发货
     - 已完成

3. **点击"导出"按钮**
   - 系统会从当前已加载的订单中筛选符合条件的订单
   - 如果没有符合条件的订单，会弹出提示
   - 自动下载Excel文件

4. **文件命名规则**:
   - 格式：`批量导出订单_[日期范围]_[状态]_导出日期.xlsx`
   - 示例：
     - `批量导出订单_2025-01-01至2025-01-31_生产中_2025-11-26.xlsx`
     - `批量导出订单_起始至2025-12-31_2025-11-26.xlsx`
     - `批量导出订单_2025-11-26.xlsx`（无筛选条件）

## 导出内容

Excel文件包含以下信息：
- 交货时间（下单时间 + 9天）
- 订单编号
- 备注
- 评论
- 高温定型费用
- 布料型号
- 布料采购米数
- 布料单价
- 布料成本
- 衬布单价
- 衬布成本
- 加工方式
- 布料高度
- 墙宽
- 每片用料
- 分片
- 倍数
- 窗户数量
- 是否定型
- 衬布
- 绑带
- 加工

## 使用场景示例

### 场景1: 导出本月所有待处理订单
1. 点击"批量导出订单"
2. 开始日期：2025-11-01
3. 结束日期：2025-11-30
4. 订单状态：待处理
5. 点击"导出"

### 场景2: 导出最近一周的生产中订单
1. 点击"批量导出订单"
2. 开始日期：7天前的日期
3. 结束日期：留空（默认到今天）
4. 订单状态：生产中
5. 点击"导出"

### 场景3: 导出所有已完成订单
1. 点击"批量导出订单"
2. 开始日期：留空
3. 结束日期：留空
4. 订单状态：已完成
5. 点击"导出"

### 场景4: 导出指定日期的所有订单
1. 点击"批量导出订单"
2. 开始日期：2025-11-20
3. 结束日期：2025-11-20
4. 订单状态：全部订单状态
5. 点击"导出"

## 两种导出方式对比

| 功能 | 导出选中订单 | 批量导出订单 |
|------|------------|------------|
| 是否需要勾选 | ✅ 需要先勾选 | ❌ 无需勾选 |
| 导出范围 | 已勾选的订单 | 所有符合条件的订单 |
| 筛选方式 | 手动勾选 | 自动筛选（时间+状态） |
| 适用场景 | 少量特定订单 | 批量导出大量订单 |
| 操作步骤 | 勾选 → 导出 | 设置条件 → 导出 |

## 注意事项

1. **数据范围限制**: 
   - 批量导出只能导出当前页面已加载的订单
   - 如果需要导出更多订单，请先通过分页加载

2. **筛选条件为空**: 
   - 如果所有条件都不设置，会导出当前页面所有订单
   
3. **没有符合条件的订单**: 
   - 如果筛选条件过滤后没有订单，会提示"没有找到符合条件的订单"

4. **日期筛选逻辑**: 
   - 开始日期从当天的00:00:00开始
   - 结束日期到当天的23:59:59结束
   - 只筛选订单创建时间（createdAt）

5. **订单状态来源**: 
   - 订单状态是存储在数据库中的自定义状态
   - 不是Shopify的原生发货/支付状态

6. **导出数据处理**:
   - 自动查询每个订单的评论
   - 自动计算布料和衬布成本
   - 自动过滤没有加工方式的商品

## 部署说明

此功能已完全实现在前端，无需数据库迁移。部署步骤：

```bash
cd /var/www/shopify-app
git pull
npm run build
pm2 restart shopify-app
```

## 常见问题

**Q: 为什么导出的订单数量比预期少？**
A: 批量导出只能导出当前已加载的订单。如果需要更多订单，请：
   - 翻页加载更多订单
   - 或使用搜索功能加载特定订单

**Q: 可以同时使用日期和状态筛选吗？**
A: 可以。系统会同时应用所有设置的条件（AND逻辑）。

**Q: 导出的Excel文件在哪里？**
A: 文件会自动下载到浏览器的默认下载文件夹。

**Q: 导出过程中可以取消吗？**
A: 可以点击对话框的"取消"按钮关闭对话框，但导出过程一旦开始无法中断。
